<!DOCTYPE html>
<html lang="es">
    <head>
        <meta charset="UTF-8">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <title>Mapa Coroplético Interactivo de Tabasco</title>
        
        <link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@400;500;700;900&family=Montserrat:wght@300;400;600&display=swap" rel="stylesheet">
        <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
        
        <link rel="stylesheet" href="/./Css/base.css">
        <link rel="stylesheet" href="/./Css/mapa.css">
        <link rel="stylesheet" href="/./Css/sidebar.css">
        <link rel="stylesheet" href="/./Css/efectos-futuristas.css">
        <link rel="stylesheet" href="/./Css/radar.css">
        <link rel="stylesheet" href="/./Css/meteoblue.css">
        <link rel="stylesheet" href="/./Css/comparador-sidebar.css">
        
        <link rel="stylesheet" href="/./Plugins/leaflet.css" />
        <script src="/./Plugins/leaflet.js"></script>
        
        <script src="https://lab.digital-democracy.org/leaflet-side-by-side/leaflet-side-by-side.js"></script>
        
        <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/leaflet.draw/1.0.4/leaflet.draw.css"/>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/leaflet.draw/1.0.4/leaflet.draw.js"></script>
        
        <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/leaflet-minimap/3.6.1/Control.MiniMap.min.css"/>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/leaflet-minimap/3.6.1/Control.MiniMap.min.js"></script>
        
        <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
    </head>
    
<body>

    <button class="sidebar-toggle-btn" id="sidebar-toggle-btn" title="Mostrar menú" aria-label="Mostrar menú">
        <i class="fas fa-bars"></i>
    </button>

    <main class="main-container">
        <div id="contenedor-del-mapa"></div>
        
        <div id="meteoblue-overlay" aria-hidden="false">
            <iframe src="https://www.meteoblue.com/es/tiempo/mapas/widget?windAnimation=1&gust=1&satellite=1&cloudsAndPrecipitation=1&temperature=1&sunshine=1&extremeForecastIndex=1&geoloc=fixed&tempunit=C&windunit=km%252Fh&lengthunit=metric&zoom=6&autowidth=auto" 
            scrolling="no" allowtransparency="true" 
            sandbox="allow-same-origin allow-scripts allow-popups allow-popups-to-escape-sandbox"></iframe>
            <div id="meteoblue-attrib"><a href="https://www.meteoblue.com/es/tiempo/mapas/index" target="_blank" rel="noopener" style="color:#fff;text-decoration:underline">meteoblue</a></div>
        </div>
        
        <button id="toggle-meteoblue-btn" type="button" aria-pressed="true" class="active">
            <i class="fa-solid fa-cloud"></i>
            <span>Meteoblue</span>
        </button>
        
        <button id="reset-zoom-btn" type="button" title="Restaurar zoom original">
            <i class="fas fa-home"></i>
        </button>

        <button id="toggle-graficas-btn" type="button" title="Mostrar/Ocultar Gráficas">
            <i class="fas fa-chart-bar"></i>
            <span>Gráficas</span>
        </button>

        <button id="comparador-barra-show" class="comparador-barra-show" title="Mostrar comparador" style="display: none;">
            <i class="fas fa-columns"></i>
            <span>Comparar</span>
        </button>
    </main>

    <div id="popup-flotante" class="popup-flotante" style="display:none;">
        <div id="popup-contenido"></div>
    </div>

    <div id="efectos-container"></div>
    <div id="sidebar-container"></div>
    
    <div id="comparador-sidebar-container"></div>
    
    <div id="graficas-container"></div>

    <script src="/./Layers/layer.js"></script>
    <script src="/./Js/wms-enhancer.js"></script> <script src="/./Js/datos-agua-loader.js"></script>
    <script src="/./Js/index.js"></script>
    <script src="/./Js/Dibujo_mnmapa.js"></script>
    <script src="/./Js/Puntos.js"></script>
    <script src="/./Js/mapa-agua.js"></script>
    <script src="/./Js/efectos-futuristas.js"></script>
    <script src="/./Js/comparador-agua.js"></script>

    <script>
        // Cargar componentes HTML externos
        function loadExternalComponents() {
            // 1. Efectos
            fetch('/Html/efectos-futuristas.html')
                .then(res => res.text())
                .then(html => {
                    document.getElementById('efectos-container').innerHTML = html;
                    if(window.initializeAllFuturisticEffects) window.initializeAllFuturisticEffects();
                });

            // 2. Gráficas
            fetch('/Html/graficas-panel.html')
                .then(res => res.text())
                .then(html => {
                    document.getElementById('graficas-container').innerHTML = html;
                    if(window.initializeGraficasPanel) window.initializeGraficasPanel();
                });

            // 3. Sidebar Principal
            fetch('/Html/sidebar.html')
                .then(res => res.text())
                .then(html => {
                    document.getElementById('sidebar-container').innerHTML = html;
                    setTimeout(() => {
                        // Mover control de capas
                        const layersControl = document.querySelector('.leaflet-control-layers');
                        const layersContainer = document.getElementById('layers-container');
                        if (layersControl && layersContainer) {
                            layersContainer.appendChild(layersControl);
                            layersControl.classList.remove('leaflet-control-layers-collapsed');
                        }
                        // Inicializar lógica del sidebar
                        if(window.setupSidebarToggle) setupSidebarToggle(); 
                        if(window.configurarEventosPaneles) window.configurarEventosPaneles();
                        
                        // Abrir sidebar por defecto
                        const sidebar = document.querySelector('.sidebar');
                        if(sidebar) {
                            sidebar.classList.remove('hidden');
                            document.body.classList.add('sidebar-open');
                        }
                    }, 500);
                });

            // 4. Comparador (Barra Inferior)
            fetch('/Html/comparador-sidebar.html')
                .then(res => res.text())
                .then(html => {
                    document.getElementById('comparador-sidebar-container').innerHTML = html;
                    // La inicialización del comparador se hace automáticamente en comparador-agua.js
                    // cuando detecta que el DOM está listo
                });
        }

        // Lógica de Sidebar Principal (Toggle)
        function setupSidebarToggle() {
            const sidebar = document.querySelector('.sidebar');
            const toggleBtn = document.getElementById('sidebar-toggle-btn');
            const closeBtn = document.getElementById('sidebar-close-btn');

            if (!sidebar) return;

            function toggleSidebar(show) {
                if (show) {
                    sidebar.classList.remove('hidden');
                    document.body.classList.add('sidebar-open');
                    if(toggleBtn) toggleBtn.style.display = 'none';
                } else {
                    sidebar.classList.add('hidden');
                    document.body.classList.remove('sidebar-open');
                    if(toggleBtn) toggleBtn.style.display = 'flex';
                }
            }

            if(toggleBtn) toggleBtn.onclick = (e) => { e.stopPropagation(); toggleSidebar(true); };
            if(closeBtn) closeBtn.onclick = (e) => { e.stopPropagation(); toggleSidebar(false); };
        }

        // Configuración de Meteoblue Toggle
        function setupMeteoblue() {
            const btn = document.getElementById('toggle-meteoblue-btn');
            const overlay = document.getElementById('meteoblue-overlay');
            if(btn && overlay) {
                let active = true;
                btn.onclick = () => {
                    active = !active;
                    overlay.style.display = active ? 'block' : 'none';
                    btn.classList.toggle('active', active);
                    
                    // Ocultar stats si meteoblue está activo
                    const stats = document.querySelector('.stats-panel');
                    if(stats) stats.style.display = active ? 'none' : 'block';
                };
            }
        }

        // Configuración Reset Zoom
        function setupResetZoom() {
            const btn = document.getElementById('reset-zoom-btn');
            if(btn && window.mapa) {
                btn.onclick = () => window.mapa.setView([17.668, -91.539], 9);
            }
        }

        // Inicialización General
        window.addEventListener('load', function() {
            loadExternalComponents();
            setTimeout(setupMeteoblue, 1000);
            setTimeout(setupResetZoom, 1000);
        });
    </script>
</body>
</html>